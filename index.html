<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="Logo GitHub.png">
<link rel="apple-touch-icon" href="Logo GitHub.png">
<meta name="theme-color" content="#d4af37">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco DRC - Firebase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .info {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .content {
            padding: 20px;
            min-height: 400px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #f0f4ff;
            color: #667eea;
            border: 1px solid #667eea;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #e8ecff;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab-btn {
            padding: 12px 0;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            flex: 1;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #4caf50;
        }

        .alert-error {
            background: #f44336;
        }

        .alert-info {
            background: #2196F3;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .transaction-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-in {
            color: #4caf50;
        }

        .transaction-out {
            color: #f44336;
        }

        .user-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .user-card-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .user-card-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .history-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        @media (max-width: 480px) {
            .container {
                border-radius: 0;
            }

            body {
                padding: 0;
            }

            .alert {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí∞ Banco DRC</h1>
            <div class="info">
                <div id="userInfo" class="hidden">
                    <div>Bienvenido <strong id="userName"></strong></div>
                    <div id="userPublicId" style="font-size: 11px; margin-top: 5px;"></div>
                    <div style="margin-top: 8px;">Saldo: <strong id="userBalance">$0.00</strong></div>
                </div>
                <div id="noUserInfo">Inicia sesi√≥n para continuar</div>
            </div>
        </div>

        <!-- Contenido -->
        <div class="content">
            <!-- Pantalla de Autenticaci√≥n -->
            <div id="authScreen" class="tab-content active">
                <div style="margin-bottom: 20px; text-align: center;">
                    <h2 style="color: #333; font-size: 18px;">¬øQui√©n eres?</h2>
                </div>

                <!-- Tabs de Registro / Login -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchAuthTab('login')">Ingresar</button>
                    <button class="tab-btn" onclick="switchAuthTab('register')">Crear cuenta</button>
                </div>

                <!-- Login -->
                <div id="loginTab" class="tab-content active">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="tu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn-primary" onclick="handleLogin()">
                        <span id="loginBtnText">Ingresar</span>
                    </button>
                </div>

                <!-- Registro -->
                <div id="registerTab" class="tab-content hidden">
                    <div class="form-group">
                        <label>Nombre completo</label>
                        <input type="text" id="registerName" placeholder="Juan P√©rez">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" placeholder="tu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a (m√≠n. 6 caracteres)</label>
                        <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn-primary" onclick="handleRegister()">
                        <span id="registerBtnText">Crear cuenta</span>
                    </button>
                </div>
            </div>

            <!-- Pantalla Principal (Despu√©s de autenticarse) -->
            <div id="mainScreen" class="tab-content hidden">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchMainTab('dashboard')">Inicio</button>
                    <button class="tab-btn" onclick="switchMainTab('transfer')">Transferir</button>
                    <button class="tab-btn" onclick="switchMainTab('history')">Historial</button>
                    <button class="tab-btn" onclick="handleLogout()">Salir</button>
                </div>

                                <!-- Panel admin (oculto por defecto, se muestra si el usuario es admin) -->
                                <div id="adminPanel" style="display:none; border:2px solid red; padding:10px; margin-top:12px;">
                                    <h3>üëë PANEL ADMIN</h3>

                                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                                        <button class="btn-secondary" onclick="cargarUsuarios()">üìã Ver usuarios</button>
                                        <button class="btn-secondary" onclick="mostrarRanking()">üìä Ranking</button>
                                    </div>

                                    <hr>

                                    <h4>üí∏ Modificar saldo</h4>
                                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                                        <input id="saldoUid" placeholder="UID del usuario" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                        <input id="saldoMonto" type="number" placeholder="Monto (+ o -)" style="width:140px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                        <button class="btn-primary" onclick="modificarSaldo()">Aplicar</button>
                                    </div>

                                    <hr>

                                    <h4>üßä Congelar por tiempo (minutos)</h4>
                                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                                        <input id="freezeUid" placeholder="UID del usuario" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                        <input id="freezeMin" type="number" placeholder="Minutos" style="width:120px; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                        <button class="btn-primary" onclick="congelarTiempo()">Congelar</button>
                                    </div>

                                    <hr>

                                    <div id="adminOutput" style="max-height:200px; overflow:auto;"></div>
                                </div>

                <!-- Tab: Dashboard -->
                <div id="dashboardTab" class="tab-content active">
                    <div class="user-card">
                        <div class="user-card-label">Tu Public ID</div>
                        <div class="user-card-value" id="dashPublicId">-</div>
                        <button class="btn-secondary" style="margin-top: 10px;" onclick="copyToClipboard()">üìã Copiar</button>
                    </div>

                    <div class="user-card">
                        <div class="user-card-label">Saldo disponible</div>
                        <div class="user-card-value" id="dashBalance">$0.00</div>
                        <div id="freezeBadge" style="display:none; margin-top:8px; color:#b71c1c; font-weight:700;">‚ùÑÔ∏è Cuenta congelada</div>
                    </div>

                    <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 13px; color: #333; line-height: 1.6;">
                        <strong>‚ÑπÔ∏è Informaci√≥n:</strong>
                        <ul style="margin-left: 20px; margin-top: 8px;">
                            <li>Comparte tu Public ID para recibir transferencias</li>
                            <li>Las transacciones se registran autom√°ticamente</li>
                            <li>Saldo inicial: $100.00</li>
                        </ul>
                    </div>
                </div>

                <!-- Tab: Transferencias -->
                <div id="transferTab" class="tab-content hidden">
                    <div style="background: #f0f4ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #333;">
                        Ingresa el Public ID del destinatario y el monto a transferir.
                    </div>

                    <div class="form-group">
                        <label>Public ID del destinatario</label>
                        <input type="text" id="transferTo" placeholder="DRC-123456">
                    </div>

                    <div class="form-group">
                        <label>Monto a transferir</label>
                        <input type="number" id="transferAmount" placeholder="0.00" min="0.01" step="0.01">
                    </div>

                    <button class="btn-primary" onclick="handleTransfer()">
                        <span id="transferBtnText">Transferir dinero</span>
                    </button>
                </div>

                <!-- Tab: Historial -->
                <div id="historyTab" class="tab-content hidden">
                    <div id="historyContainer" class="history-empty">Cargando historial...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v9+ (modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
        import { 
            getFirestore, 
                doc, 
                setDoc, 
                getDoc,
                updateDoc,
                collection,
                query,
                where,
                getDocs,
                runTransaction,
                arrayUnion,
                serverTimestamp,
                onSnapshot,
                orderBy,
                limit
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

        // ==================== CONFIGURACI√ìN FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCRLmtnPIghuQGPz-VHCw2U8NRrcavK-6c",
            authDomain: "drc-bank-d07f5.firebaseapp.com",
            projectId: "drc-bank-d07f5",
            storageBucket: "drc-bank-d07f5.firebasestorage.app",
            messagingSenderId: "32262689428",
            appId: "1:32262689428:web:8a12b34b7e02fcc79c5a81"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ==================== VARIABLES GLOBALES ====================
        let currentUser = null;
        let unsubscribeUser = null;
        let currentUserData = null; // Datos del usuario cargados/actualizados en tiempo real

        // ==================== INICIALIZACI√ìN ====================
        // Verificar usuario al cargar la p√°gina
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Escuchar cambios en tiempo real para este usuario
                escucharUsuario(user.uid);
                await loadUserData();
                showMainScreen();
            } else {
                currentUser = null;
                // Si hay un listener activo lo desenlazamos
                if (unsubscribeUser) {
                    try { unsubscribeUser(); } catch (e) { /* ignore */ }
                    unsubscribeUser = null;
                }
                currentUserData = null;
                showAuthScreen();
            }
        });

        // ==================== FUNCIONES DE AUTENTICACI√ìN ====================
        /**
         * Maneja el registro de nuevos usuarios
         * - Crea cuenta con Firebase Auth
         * - Genera publicId √∫nico (DRC-XXXXXX)
         * - Crea documento en Firestore con datos iniciales
         */
        async function handleRegister() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!name || !email || !password) {
                showAlert('Completa todos los campos', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            const btn = document.getElementById('registerBtnText');
            btn.innerHTML = '<span class="loading"></span>';

            try {
                // Crear usuario en Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;

                // Generar publicId √∫nico
                const publicId = await generatePublicId();

                // Crear documento en Firestore
                await setDoc(doc(db, 'users', uid), {
                    uid: uid,
                    name: name,
                    email: email,
                    publicId: publicId,
                    saldo: 100,
                    createdAt: serverTimestamp(),
                    transactions: []
                });

                showAlert('¬°Cuenta creada exitosamente!', 'success');
                document.getElementById('registerName').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                switchAuthTab('login');

            } catch (error) {
                console.error('Error en registro:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAlert('Este email ya est√° registrado', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showAlert('Email inv√°lido', 'error');
                } else {
                    showAlert('Error: ' + error.message, 'error');
                }
            } finally {
                btn.textContent = 'Crear cuenta';
            }
        }

        /**
         * Maneja el login de usuarios existentes
         * - Autentica con Firebase Auth
         * - La sesi√≥n se mantiene autom√°ticamente
         */
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAlert('Completa todos los campos', 'error');
                return;
            }

            const btn = document.getElementById('loginBtnText');
            btn.innerHTML = '<span class="loading"></span>';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showAlert('¬°Bienvenido!', 'success');
            } catch (error) {
                console.error('Error en login:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showAlert('Email o contrase√±a incorrectos', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showAlert('Email inv√°lido', 'error');
                } else {
                    showAlert('Error: ' + error.message, 'error');
                }
            } finally {
                btn.textContent = 'Ingresar';
            }
        }

        /**
         * Cierra la sesi√≥n del usuario
         * - Limpia datos locales
         * - Vuelve a mostrar pantalla de autenticaci√≥n
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                currentUser = null;
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                showAlert('Sesi√≥n cerrada', 'info');
            } catch (error) {
                showAlert('Error al cerrar sesi√≥n: ' + error.message, 'error');
            }
        }

        // ==================== FUNCIONES DE FIRESTORE ====================
        /**
         * Carga los datos del usuario actual desde Firestore
         * - Obtiene: nombre, publicId, saldo, email
         * - Carga el historial de transacciones
         */
        async function loadUserData() {
            if (!currentUser) return;

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();

                    // Valores por defecto (por si no existen en Firestore)
                    userData.isAdmin = userData.isAdmin === true;
                    userData.cuentaCongelada = userData.cuentaCongelada === true;

                    // Guardar en memoria para comprobaciones (p.ej. bloqueo de transferencias)
                    currentUserData = userData;

                    document.getElementById('userName').textContent = userData.name;
                    document.getElementById('userPublicId').textContent = `ID: ${userData.publicId}`;
                    document.getElementById('userBalance').textContent = `$${(userData.saldo || 0).toFixed(2)}`;
                    document.getElementById('dashPublicId').textContent = userData.publicId;
                    document.getElementById('dashBalance').textContent = `$${(userData.saldo || 0).toFixed(2)}`;

                    // Mostrar panel admin si corresponde
                    const adminPanel = document.getElementById('adminPanel');
                    if (adminPanel) {
                        adminPanel.style.display = userData.isAdmin ? 'block' : 'none';
                    }

                    // Mostrar badge de cuenta congelada si aplica
                    const badge = document.getElementById('freezeBadge');
                    if (badge) {
                        if (userData.cuentaCongelada) {
                            let text = '‚ùÑÔ∏è Cuenta congelada';
                            if (userData.congeladoHasta) {
                                const remaining = userData.congeladoHasta - Date.now();
                                if (remaining > 0) {
                                    const mins = Math.ceil(remaining / 60000);
                                    text += ` ‚Äî ${mins} min.`;
                                }
                            }
                            badge.textContent = text;
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                showAlert('Error al cargar datos de usuario', 'error');
            }
        }

        /**
         * Realiza una transferencia entre usuarios
         * - Valida fondos suficientes
         * - Usa transacci√≥n de Firestore para atomicidad
         * - Registra en historial de ambos usuarios
         */
        async function handleTransfer() {
            if (!currentUser) {
                showAlert('Debes estar autenticado', 'error');
                return;
            }

            // Bloquear transferencias si la cuenta del remitente est√° congelada
            if (currentUserData && currentUserData.cuentaCongelada) {
                showAlert('‚ùå Tu cuenta est√° congelada por el administrador', 'error');
                return;
            }

            const recipientPublicId = document.getElementById('transferTo').value.trim();
            const amount = parseFloat(document.getElementById('transferAmount').value);

            if (!recipientPublicId) {
                showAlert('Ingresa el Public ID del destinatario', 'error');
                return;
            }

            if (!amount || amount <= 0) {
                showAlert('Ingresa un monto v√°lido', 'error');
                return;
            }

            const btn = document.querySelector('#transferTab .btn-primary span');
            btn.innerHTML = '<span class="loading"></span>';

            try {
                // Buscar usuario por publicId
                const q = query(collection(db, 'users'), where('publicId', '==', recipientPublicId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showAlert('Usuario no encontrado', 'error');
                    btn.textContent = 'Transferir dinero';
                    return;
                }

                const recipientDoc = querySnapshot.docs[0];
                const recipientId = recipientDoc.id;
                const recipientData = recipientDoc.data();

                if (recipientId === currentUser.uid) {
                    showAlert('No puedes transferir a tu propia cuenta', 'error');
                    btn.textContent = 'Transferir dinero';
                    return;
                }

                // Usar transacci√≥n para garantizar consistencia
                await runTransaction(db, async (transaction) => {
                    const senderRef = doc(db, 'users', currentUser.uid);
                    const recipientRef = doc(db, 'users', recipientId);

                    const senderSnap = await transaction.get(senderRef);
                    const recipientSnap = await transaction.get(recipientRef);

                    if (!senderSnap.exists() || !recipientSnap.exists()) {
                        throw new Error('Usuario no encontrado');
                    }

                    const senderBalance = senderSnap.data().saldo;
                    const senderName = senderSnap.data().name;

                    if ((senderBalance || 0) < amount) {
                        throw new Error('Fondos insuficientes');
                    }

                    const timestamp = new Date();
                    const transactionRecord = {
                        id: 'tx_' + Date.now(),
                        type: 'transfer',
                        amount: amount,
                        from: currentUser.uid,
                        fromName: senderName,
                        to: recipientId,
                        toName: recipientData.name,
                        timestamp: timestamp.toISOString(),
                        status: 'completed'
                    };

                    // Actualizar saldo del remitente (d√©bito)
                    transaction.update(senderRef, {
                        saldo: (senderSnap.data().saldo || 0) - amount,
                        transactions: arrayUnion({
                            ...transactionRecord,
                            direction: 'out'
                        })
                    });

                    // Actualizar saldo del destinatario (cr√©dito)
                    transaction.update(recipientRef, {
                        saldo: (recipientSnap.data().saldo || 0) + amount,
                        transactions: arrayUnion({
                            ...transactionRecord,
                            direction: 'in'
                        })
                    });
                });

                showAlert(`‚úì Transferencia de $${amount.toFixed(2)} enviada a ${recipientData.name}`, 'success');
                document.getElementById('transferTo').value = '';
                document.getElementById('transferAmount').value = '';
                await loadUserData();
                await loadTransactionHistory();

            } catch (error) {
                console.error('Error en transferencia:', error);
                if (error.message === 'Fondos insuficientes') {
                    showAlert('No tienes saldo suficiente', 'error');
                } else if (error.message === 'Usuario no encontrado') {
                    showAlert('Usuario no encontrado', 'error');
                } else {
                    showAlert('Error: ' + error.message, 'error');
                }
            } finally {
                btn.textContent = 'Transferir dinero';
            }
        }

        /**
         * Carga el historial de transacciones del usuario
         * - Filtra por remitente y destinatario
         * - Ordena por fecha (m√°s reciente primero)
         */
        async function loadTransactionHistory() {
            if (!currentUser) return;

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDocSnap = await getDoc(userDocRef);

                const container = document.getElementById('historyContainer');

                if (!userDocSnap.exists() || !userDocSnap.data().transactions) {
                    container.innerHTML = '<div class="history-empty">Sin transacciones</div>';
                    return;
                }

                const transactions = userDocSnap.data().transactions || [];
                
                if (transactions.length === 0) {
                    container.innerHTML = '<div class="history-empty">Sin transacciones</div>';
                    return;
                }

                // Ordenar por fecha (m√°s reciente primero)
                const sorted = [...transactions].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );

                container.innerHTML = '';

                sorted.forEach(tx => {
                    const div = document.createElement('div');
                    div.className = 'transaction-item';

                    const isIncoming = tx.direction === 'in';
                    const className = isIncoming ? 'transaction-in' : 'transaction-out';
                    const symbol = isIncoming ? '+' : '-';
                    const otherUser = isIncoming ? tx.fromName : tx.toName;

                    const date = new Date(tx.timestamp).toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #333;">
                                    ${isIncoming ? 'üì• De:' : 'üì§ Para:'} ${otherUser}
                                </div>
                                <div style="font-size: 12px; color: #999; margin-top: 3px;">${date}</div>
                            </div>
                            <div class="${className}" style="font-weight: bold; font-size: 15px;">
                                ${symbol}$${tx.amount.toFixed(2)}
                            </div>
                        </div>
                    `;

                    container.appendChild(div);
                });

            } catch (error) {
                console.error('Error cargando historial:', error);
                showAlert('Error al cargar historial', 'error');
            }
        }

        // ==================== UTILIDADES ====================
        /**
         * Genera un publicId √∫nico en formato DRC-XXXXXX
         * Valida que no exista en la base de datos
         */
        async function generatePublicId() {
            let publicId;
            let exists = true;

            while (exists) {
                const random = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
                publicId = `DRC-${random}`;

                const q = query(collection(db, 'users'), where('publicId', '==', publicId));
                const querySnapshot = await getDocs(q);
                exists = !querySnapshot.empty;
            }

            return publicId;
        }

        /**
         * Escucha en tiempo real los cambios del documento del usuario
         * y actualiza la UI autom√°ticamente (saldo y publicId).
         */
        function escucharUsuario(uid) {
            const userRef = doc(db, 'users', uid);

            // Si ya hay un listener activo, lo cerramos
            if (unsubscribeUser) {
                try { unsubscribeUser(); } catch (e) { /* ignore */ }
                unsubscribeUser = null;
            }

            unsubscribeUser = onSnapshot(userRef, async (docSnap) => {
                if (!docSnap || !docSnap.exists()) return;
                const data = docSnap.data();

                // Valores por defecto (por si no existen en Firestore)
                data.isAdmin = data.isAdmin === true;
                data.cuentaCongelada = data.cuentaCongelada === true;

                    // Guardar en memoria (usado por ejemplo para bloquear transferencias)
                    currentUserData = data;

                    // Mostrar badge de cuenta congelada si aplica (y mostrar tiempo restante si est√° disponible)
                    const badge = document.getElementById('freezeBadge');
                    if (badge) {
                        if (data.cuentaCongelada) {
                            let text = '‚ùÑÔ∏è Cuenta congelada';
                            if (data.congeladoHasta) {
                                const remaining = data.congeladoHasta - Date.now();
                                if (remaining > 0) {
                                    const mins = Math.ceil(remaining / 60000);
                                    text += ` ‚Äî ${mins} min.`;
                                }
                            }
                            badge.textContent = text;
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }

                const saldoVal = (data.saldo || 0).toFixed(2);
                const publicIdVal = data.publicId || '-';

                // IDs que actualizamos para compatibilidad
                const balanceIds = ['userBalance', 'dashBalance', 'saldo'];
                balanceIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = `$${saldoVal}`;
                });

                const publicIds = ['dashPublicId', 'userPublicId', 'publicId'];
                publicIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = publicIdVal;
                });

                // Mostrar/ocultar panel admin seg√∫n privilegios
                const adminPanel = document.getElementById('adminPanel');
                if (adminPanel) {
                    adminPanel.style.display = data.isAdmin ? 'block' : 'none';
                }

                // Descongelado autom√°tico si expir√≥ el tiempo (solo para el usuario que recibe el snapshot)
                if (data.cuentaCongelada && data.congeladoHasta) {
                    try {
                        if (Date.now() > data.congeladoHasta) {
                            if (auth.currentUser && auth.currentUser.uid === uid) {
                                await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                                    cuentaCongelada: false,
                                    congeladoHasta: null
                                });
                            }
                        }
                    } catch (e) {
                        console.error('Error auto-descongelando:', e);
                    }
                }
            }, (err) => {
                console.error('onSnapshot error:', err);
            });
        }

        /**
         * Cambia de pesta√±a dentro de la pantalla de autenticaci√≥n
         */
        function switchAuthTab(tab) {
            document.querySelectorAll('#authScreen .tab-content').forEach(el => {
                el.classList.remove('active');
                el.classList.add('hidden');
            });
            document.querySelectorAll('#authScreen .tab-btn').forEach(el => {
                el.classList.remove('active');
            });

            document.getElementById(tab + 'Tab').classList.remove('hidden');
            document.getElementById(tab + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        /**
         * Cambia de pesta√±a dentro de la pantalla principal
         */
        async function switchMainTab(tab) {
            document.querySelectorAll('#mainScreen .tab-content').forEach(el => {
                el.classList.remove('active');
                el.classList.add('hidden');
            });
            document.querySelectorAll('#mainScreen .tab-btn').forEach(el => {
                el.classList.remove('active');
            });

            if (tab !== 'logout') {
                document.getElementById(tab + 'Tab').classList.remove('hidden');
                document.getElementById(tab + 'Tab').classList.add('active');
                event.target.classList.add('active');

                // Cargar datos cuando se abre historial
                if (tab === 'history') {
                    await loadTransactionHistory();
                }
            }
        }

        /**
         * Muestra la pantalla de autenticaci√≥n
         */
        function showAuthScreen() {
            document.getElementById('authScreen').classList.add('active');
            document.getElementById('mainScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('noUserInfo').classList.remove('hidden');
        }

        /**
         * Muestra la pantalla principal
         */
        function showMainScreen() {
            document.getElementById('authScreen').classList.remove('active');
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.add('active');
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('noUserInfo').classList.add('hidden');
        }

        /**
         * Muestra alertas en pantalla
         */
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        /**
         * Copia el Public ID al portapapeles
         */
        function copyToClipboard() {
            const publicId = document.getElementById('dashPublicId').textContent;
            navigator.clipboard.writeText(publicId).then(() => {
                showAlert('Public ID copiado al portapapeles', 'success');
            });
        }

        // ==================== FUNCIONES ADMIN ====================
        async function congelar() {
            const uid = document.getElementById('adminUid').value.trim();
            if (!uid) return showAlert('UID vac√≠o', 'error');

            try {
                await updateDoc(doc(db, 'users', uid), {
                    cuentaCongelada: true
                });
                showAlert('Cuenta congelada', 'success');
            } catch (e) {
                console.error('Error congelando cuenta:', e);
                showAlert('Error: ' + e.message, 'error');
            }
        }

        async function descongelar() {
            const uid = document.getElementById('adminUid').value.trim();
            if (!uid) return showAlert('UID vac√≠o', 'error');

            try {
                await updateDoc(doc(db, 'users', uid), {
                    cuentaCongelada: false
                });
                showAlert('Cuenta descongelada', 'success');
            } catch (e) {
                console.error('Error descongelando cuenta:', e);
                showAlert('Error: ' + e.message, 'error');
            }
        }

        // ==================== FUNCIONES ADMIN AVANZADAS ====================
        async function cargarUsuarios() {
            try {
                const snap = await getDocs(collection(db, 'users'));
                let html = '<h4>Usuarios</h4><ul>';

                snap.forEach(docu => {
                    const u = docu.data();
                    const saldo = (u.saldo || 0).toFixed(2);
                    const estado = u.cuentaCongelada ? 'üßä' : 'üü¢';
                    html += `<li style="padding:6px 0; border-bottom:1px solid #eee;">${u.name || 'Sin nombre'} | UID: ${docu.id} | $${saldo} | ${estado}</li>`;
                });

                html += '</ul>';
                document.getElementById('adminOutput').innerHTML = html;
            } catch (e) {
                console.error('Error cargando usuarios:', e);
                showAlert('Error cargando usuarios', 'error');
            }
        }

        async function modificarSaldo() {
            const uid = document.getElementById('saldoUid').value.trim();
            const monto = Number(document.getElementById('saldoMonto').value);
            if (!uid || !monto) return showAlert('Datos incompletos', 'error');

            try {
                const ref = doc(db, 'users', uid);
                const snap = await getDoc(ref);
                if (!snap.exists()) return showAlert('Usuario no existe', 'error');

                const nuevoSaldo = (snap.data().saldo || 0) + monto;
                if (nuevoSaldo < 0) return showAlert('Saldo negativo no permitido', 'error');

                await updateDoc(ref, { saldo: nuevoSaldo });
                showAlert('Saldo actualizado', 'success');
                cargarUsuarios();
            } catch (e) {
                console.error('Error modificando saldo:', e);
                showAlert('Error: ' + e.message, 'error');
            }
        }

        async function congelarTiempo() {
            const uid = document.getElementById('freezeUid').value.trim();
            const min = Number(document.getElementById('freezeMin').value);
            if (!uid || !min) return showAlert('Datos incompletos', 'error');

            try {
                const hasta = Date.now() + min * 60000;
                await updateDoc(doc(db, 'users', uid), {
                    cuentaCongelada: true,
                    congeladoHasta: hasta
                });
                showAlert(`Cuenta congelada por ${min} minutos`, 'success');
                cargarUsuarios();
            } catch (e) {
                console.error('Error congelando por tiempo:', e);
                showAlert('Error: ' + e.message, 'error');
            }
        }

        async function mostrarRanking() {
            try {
                const q = query(collection(db, 'users'), orderBy('saldo', 'desc'), limit(10));
                const snap = await getDocs(q);
                let html = '<h4>üèÜ Ranking</h4><ol>';

                snap.forEach(docu => {
                    const u = docu.data();
                    html += `<li style="padding:4px 0;">${u.name || '?'} ‚Äî $${(u.saldo||0).toFixed(2)}</li>`;
                });

                html += '</ol>';
                document.getElementById('adminOutput').innerHTML = html;
            } catch (e) {
                console.error('Error mostrando ranking:', e);
                showAlert('Error: ' + e.message, 'error');
            }
        }

        // Exponer funciones globales
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleLogout = handleLogout;
        window.handleTransfer = handleTransfer;
        window.switchAuthTab = switchAuthTab;
        window.switchMainTab = switchMainTab;
        window.copyToClipboard = copyToClipboard;
        window.loadTransactionHistory = loadTransactionHistory;
        window.congelar = congelar;
        window.descongelar = descongelar;
        window.cargarUsuarios = cargarUsuarios;
        window.modificarSaldo = modificarSaldo;
        window.congelarTiempo = congelarTiempo;
        window.mostrarRanking = mostrarRanking;

    </script>
</body>
</html>

